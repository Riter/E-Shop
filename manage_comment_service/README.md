# Сервис Комментариев

Сервис для управления комментариями и рейтингами товаров в системе электронной коммерции.

## Структура Проекта

```
manage_comment_service/
├── cmd/                    # Точки входа приложения
├── internal/              # Внутренний код приложения
│   ├── auth/             # Код аутентификации
│   ├── config/           # Управление конфигурацией
│   ├── db/               # Подключение и настройка базы данных
│   ├── handler/          # HTTP обработчики запросов
│   ├── models/           # Модели данных и DTO
│   ├── repository/       # Слой доступа к данным
│   └── service/          # Бизнес-логика
├── migrations/           # Миграции базы данных
├── tests/               # Тесты
├── environment/         # Конфигурация окружения
├── Dockerfile          # Конфигурация контейнера
├── go.mod              # Определение Go модуля
└── go.sum              # Контрольные суммы Go модуля
```

## API Эндпоинты

### Публичные Эндпоинты (не требуют авторизации)

1. **Получить комментарий по ID**
   - `GET /comments/{id}`
   - Пример запроса:
   ```bash
   curl http://localhost:8080/comments/123
   ```
   - Пример ответа:
   ```json
   {
     "id": 123,
     "product_id": 456,
     "user_id": 789,
     "text": "Отличный товар!",
     "rating": 5,
     "created_at": "2024-03-20T10:00:00Z",
     "updated_at": "2024-03-20T10:00:00Z"
   }
   ```

2. **Получить все комментарии товара**
   - `GET /products/{productID}/comments`
   - Пример запроса:
   ```bash
   curl http://localhost:8080/products/456/comments
   ```
   - Пример ответа:
   ```json
   [
     {
       "id": 123,
       "product_id": 456,
       "user_id": 789,
       "text": "Отличный товар!",
       "rating": 5,
       "created_at": "2024-03-20T10:00:00Z",
       "updated_at": "2024-03-20T10:00:00Z"
     },
     {
       "id": 124,
       "product_id": 456,
       "user_id": 790,
       "text": "Хорошее качество",
       "rating": 4,
       "created_at": "2024-03-20T11:00:00Z",
       "updated_at": "2024-03-20T11:00:00Z"
     }
   ]
   ```

3. **Получить рейтинг товара**
   - `GET /products/{productID}/rating`
   - Пример запроса:
   ```bash
   curl http://localhost:8080/products/456/rating
   ```
   - Пример ответа:
   ```json
   {
     "average_rating": 4.5,
     "total_ratings": 2
   }
   ```

### Защищенные Эндпоинты (требуют заголовок X-User-ID)

1. **Создать комментарий**
   - `POST /comments`
   - Заголовки: `X-User-ID: <user_id>`
   - Пример запроса:
   ```bash
   curl -X POST http://localhost:8080/comments \
     -H "Content-Type: application/json" \
     -H "X-User-ID: 789" \
     -d '{
       "product_id": 456,
       "text": "Отличный товар!",
       "rating": 5
     }'
   ```
   - Пример ответа:
   ```json
   {
     "id": 123
   }
   ```

2. **Обновить комментарий**
   - `PUT /comments/{id}`
   - Заголовки: `X-User-ID: <user_id>`
   - Пример запроса:
   ```bash
   curl -X PUT http://localhost:8080/comments/123 \
     -H "Content-Type: application/json" \
     -H "X-User-ID: 789" \
     -d '{
       "text": "Обновленный отзыв после длительного использования",
       "rating": 4
     }'
   ```
   - Пример ответа: HTTP 200 OK

3. **Удалить комментарий**
   - `DELETE /comments/{id}`
   - Заголовки: `X-User-ID: <user_id>`
   - Пример запроса:
   ```bash
   curl -X DELETE http://localhost:8080/comments/123 \
     -H "X-User-ID: 789"
   ```
   - Пример ответа: HTTP 200 OK

## Запуск Сервиса

### Использование Docker

1. Собрать контейнер:
```bash
docker build -t comments-service .
```

2. Запустить контейнер:
```bash
docker run -p 8080:8080 comments-service
```

### Переменные Окружения

Сервис требует следующие переменные окружения:
- `DB_HOST`: Хост базы данных
- `DB_PORT`: Порт базы данных
- `DB_USER`: Пользователь базы данных
- `DB_PASSWORD`: Пароль базы данных
- `DB_NAME`: Имя базы данных
- `SERVER_PORT`: Порт HTTP сервера (по умолчанию: 8080)

## Обработка Ошибок

Сервис возвращает следующие HTTP статусы:
- 200: Успешное выполнение
- 201: Ресурс создан
- 400: Неверный формат запроса
- 401: Не авторизован
- 403: Нет прав доступа
- 404: Ресурс не найден
- 500: Внутренняя ошибка сервера

## Безопасность

- Все защищенные эндпоинты требуют заголовок `X-User-ID`
- Пользователи могут изменять только свои комментарии
- Выполняется валидация всех входящих данных

## Важные Замечания

1. При создании комментария:
   - `product_id` должен существовать
   - `rating` должен быть от 1 до 5
   - `text` не может быть пустым

2. При обновлении комментария:
   - Можно изменить только `text` и `rating`
   - Нельзя изменить `product_id` или `user_id`

3. При удалении комментария:
   - Комментарий должен принадлежать пользователю из заголовка `X-User-ID`
   - После удаления комментарий нельзя восстановить