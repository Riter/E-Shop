# Comments Service

Сервис для управления комментариями к товарам в E-Shop. Предоставляет API для создания, чтения, обновления и удаления комментариев, с поддержкой JWT аутентификации.

## Содержание
- [Установка и запуск](#установка-и-запуск)
- [API Endpoints](#api-endpoints)
- [Аутентификация](#аутентификация)
- [Примеры запросов](#примеры-запросов)
- [Тестирование](#тестирование)

### Запуск сервиса
```bash
go run cmd/main.go
```

Сервис запустится на порту 30333.

## API Endpoints

### Публичные эндпоинты (не требуют аутентификации)

#### GET /comments/{id}
Получение комментария по ID.

**Ответ:**
```json
{
    "id": 1,
    "product_id": 123,
    "user_id": 456,
    "content": "Отличный товар!",
    "rating": 5,
    "created_at": "2024-05-07T12:00:00Z",
    "updated_at": "2024-05-07T12:00:00Z"
}
```

#### GET /products/{productID}/comments
Получение всех комментариев для конкретного товара.

**Ответ:**
```json
[
    {
        "id": 1,
        "product_id": 123,
        "user_id": 456,
        "content": "Отличный товар!",
        "rating": 5,
        "created_at": "2024-05-07T12:00:00Z",
        "updated_at": "2024-05-07T12:00:00Z"
    },
    {
        "id": 2,
        "product_id": 123,
        "user_id": 789,
        "content": "Хорошее качество",
        "rating": 4,
        "created_at": "2024-05-07T13:00:00Z",
        "updated_at": "2024-05-07T13:00:00Z"
    }
]
```

### Защищенные эндпоинты (требуют JWT токен)

#### POST /comments
Создание нового комментария.

**Запрос:**
```json
{
    "product_id": 123,
    "content": "Отличный товар!",
    "rating": 5
}
```

**Ответ:**
```json
{
    "id": 1
}
```

#### PUT /comments/{id}
Обновление существующего комментария.

**Запрос:**
```json
{
    "content": "Обновленный комментарий",
    "rating": 4
}
```

**Ответ:**
```json
{
    "id": 1,
    "product_id": 123,
    "user_id": 456,
    "content": "Обновленный комментарий",
    "rating": 4,
    "created_at": "2024-05-07T12:00:00Z",
    "updated_at": "2024-05-07T13:00:00Z"
}
```

#### DELETE /comments/{id}
Удаление комментария.

**Ответ:**
```json
{
    "message": "Comment deleted successfully"
}
```

## Аутентификация

Сервис использует JWT (JSON Web Tokens) для аутентификации. Токен должен быть передан в заголовке `Authorization` в формате:
```
Authorization: Bearer <token>
```

JWT токен должен содержать следующие claims:
```json
{
    "uid": 123,        // ID пользователя
    "email": "user@example.com",
    "app_id": 1,
    "exp": 1234567890, // время истечения токена
    "iss": "auth-service"
}
```

## Примеры запросов

### Создание комментария
```bash
curl -X POST http://localhost:30333/comments \
  -H "Authorization: Bearer <your-jwt-token>" \
  -H "Content-Type: application/json" \
  -d '{
    "product_id": 123,
    "content": "Отличный товар!",
    "rating": 5
  }'
```

### Получение комментариев товара
```bash
curl http://localhost:30333/products/123/comments
```

### Обновление комментария
```bash
curl -X PUT http://localhost:30333/comments/1 \
  -H "Authorization: Bearer <your-jwt-token>" \
  -H "Content-Type: application/json" \
  -d '{
    "content": "Обновленный комментарий",
    "rating": 4
  }'
```

## Тестирование

### Запуск тестов
```bash
go test -v ./tests/integration/...
```

Тесты проверяют:
- CRUD операции с комментариями
- JWT аутентификацию
- Права доступа (пользователь может изменять только свои комментарии)
- Валидацию входных данных
- Обработку ошибок

## Безопасность

- Все защищенные эндпоинты требуют валидный JWT токен
- Проверяется соответствие ID пользователя в токене и автора комментария
- Токены имеют ограниченный срок действия
- Поддерживается SSL/TLS для защищенного соединения

## Обработка ошибок

Сервис возвращает следующие HTTP статусы:
- 200 OK - успешное выполнение запроса
- 201 Created - успешное создание ресурса
- 400 Bad Request - неверный формат запроса
- 401 Unauthorized - отсутствует или неверный токен
- 403 Forbidden - нет прав на выполнение операции
- 404 Not Found - ресурс не найден
- 500 Internal Server Error - внутренняя ошибка сервера